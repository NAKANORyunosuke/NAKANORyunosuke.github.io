{% assign page_lang = page.lang | default: 'ja' %}
<!DOCTYPE html>
<html lang="{{ page_lang }}" data-lang="{{ page_lang }}">

<head>
  {% include head.html %}
  <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
  <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4/dist/js/splide.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const slider = document.getElementById('image-slider');
      if (slider) {
        new Splide(slider, {
          type: 'loop',
          perPage: 1,
          autoplay: true,
          pauseOnHover: true,
          gap: '1rem'
        }).mount();
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
  <script defer>
    (function () {
      const fontFamily = 'IBM Plex Sans, Spectral, serif';

      function currentTheme() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
          ? 'dark'
          : 'default';
      }

      function initMermaid(theme) {
        mermaid.initialize({
          startOnLoad: false,
          securityLevel: 'loose',
          theme,
          fontFamily,
          flowchart: {
            htmlLabels: false,
            useMaxWidth: true,
            wrap: true
          },
          themeVariables: {
            fontSize: '16px'
          }
        });
      }

      function rerenderMermaid(theme) {
        mermaid.initialize({
          startOnLoad: false,
          securityLevel: 'loose',
          theme,
          fontFamily,
          flowchart: { htmlLabels: false, useMaxWidth: true, wrap: true },
          themeVariables: { fontSize: '16px' }
        });

        const nodes = document.querySelectorAll('.mermaid');
        nodes.forEach((el) => {
          if (el.getAttribute('data-raw')) {
            el.innerHTML = el.getAttribute('data-raw');
          }
        });
        mermaid.run({ nodes });
      }

      window.addEventListener('DOMContentLoaded', async () => {
        document.querySelectorAll('.mermaid').forEach((el) => {
          if (!el.getAttribute('data-raw')) {
            el.setAttribute('data-raw', el.textContent);
          }
        });

        initMermaid(currentTheme());
        await mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
      });

      if (window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener('change', (e) => {
          document.documentElement.classList.toggle('dark-mermaid', e.matches);
          rerenderMermaid(e.matches ? 'dark' : 'default');
        });
      }

      window.setMermaidTheme = function (theme) {
        if (theme !== 'default' && theme !== 'dark') return;
        document.documentElement.classList.toggle('dark-mermaid', theme === 'dark');
        rerenderMermaid(theme);
      };
    })();
  </script>
</head>

<body>
  <div class="site-shell">
    {% include header.html %}

    <div class="site-body">
      <aside class="site-nav-col">
        {% include nav.html %}
      </aside>
      <main class="site-main">
        <article class="content-area">
          {{ content }}
        </article>
      </main>
      <aside class="site-toc" id="page-toc" data-toc>
        <div class="site-toc__title">
          <span class="lang-ja">目次</span>
          <span class="lang-en">Outline</span>
        </div>
        <nav aria-label="On-page navigation">
          <ul class="site-toc__list" data-toc-list>
            <li class="site-toc__item site-toc__placeholder">
              <span class="lang-ja">本文の見出しから自動生成されます。</span>
              <span class="lang-en">Headings will appear here automatically.</span>
            </li>
          </ul>
        </nav>
      </aside>
    </div>

    <footer class="site-footer">
      <div class="site-footer__links">
        <a href="{{ '/privacy-policy.html' | relative_url }}">
          <span class="lang-ja">プライバシーポリシー</span>
          <span class="lang-en">Privacy Policy</span>
        </a>
      </div>
      <div>
        <p class="lang-ja">最終更新: <span id="last-updated-ja">-</span></p>
        <p class="lang-en">Last updated: <span id="last-updated-en">-</span></p>
      </div>
    </footer>
  </div>

  {% assign cache_bust = site.github.build_revision %}
  {% unless cache_bust %}
  {% assign cache_bust = site.time | date: '%s' %}
  {% endunless %}
  <script src="{{ '/assets/js/lang-switch.js' | relative_url }}?v={{ cache_bust }}"></script>
  <script src="{{ '/assets/menu.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/animations.js' | relative_url }}?v={{ cache_bust }}" defer></script>
  <script src="{{ '/assets/js/mermaid-panzoom.js' | relative_url }}" defer></script>
  <script src="{{ '/assets/js/toc.js' | relative_url }}?v={{ cache_bust }}" defer></script>
  <script>
    const d = new Date(document.lastModified);
    const z2 = (n) => String(n).padStart(2, '0');
    const yyyy = d.getFullYear();
    const mm = z2(d.getMonth() + 1);
    const dd = z2(d.getDate());
    const hh = z2(d.getHours());
    const mi = z2(d.getMinutes());
    const formatted = `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
    const lastJa = document.getElementById('last-updated-ja');
    const lastEn = document.getElementById('last-updated-en');
    if (lastJa) lastJa.textContent = formatted;
    if (lastEn) lastEn.textContent = formatted;
  </script>
</body>

</html>